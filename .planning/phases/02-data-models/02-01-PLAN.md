---
phase: 02-data-models
plan: 01
type: execute
---

<objective>
Create the normalized data model for joke storage and multi-dimensional filtering.

Purpose: Establish the database schema that enables flexible search across format, tone, age rating, context, language, and culture dimensions.
Output: 8 Django models with migrations applied and admin interface configured.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-models/02-CONTEXT.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

**Key files:**
@JokesForProject/settings.py

**Tech stack available:**
- Django 5.x with PostgreSQL configured
- python-dotenv for environment variables

**Constraining decisions:**
- Phase 01-03: PostgreSQL database `jokesfor` configured and connected
- CONTEXT.md: Search-first platform - every field must serve filtering/discovery
- CONTEXT.md: Three search patterns - situation-based, tone-based, audience-based
- CONTEXT.md: English only for MVP (but Language model for future)

**Database Design (8 tables, 3NF normalized):**

| Model | Type | Relationship | Values |
|-------|------|--------------|--------|
| Joke | Main | â€” | text, setup, punchline, timestamps |
| Format | Lookup | FK | one-liner, setup-punchline, short-story |
| AgeRating | Lookup | FK | kid-safe, teen, adult, family-friendly |
| Tone | Lookup | M2M | clean, dark, dad-jokes, puns, sarcasm |
| ContextTag | Lookup | M2M | wedding, work, school, presentation, icebreaker |
| Language | Lookup | FK | en (MVP), extensible |
| CultureTag | Lookup | M2M | American, British, universal |
| Source | Lookup | FK | attribution/origin |
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create jokes app and implement all models</name>
  <files>jokes/__init__.py, jokes/models.py, jokes/apps.py, JokesForProject/settings.py</files>
  <action>
1. Run `python manage.py startapp jokes` to create the app

2. Add 'jokes' to INSTALLED_APPS in settings.py

3. Create models in jokes/models.py:

**Lookup models (create BEFORE Joke to satisfy FK references):**

```python
class Format(models.Model):
    name = models.CharField(max_length=50, unique=True)
    slug = models.SlugField(max_length=50, unique=True)
    description = models.TextField(blank=True)

class AgeRating(models.Model):
    name = models.CharField(max_length=50, unique=True)
    slug = models.SlugField(max_length=50, unique=True)
    description = models.TextField(blank=True)
    min_age = models.PositiveSmallIntegerField(null=True, blank=True)

class Tone(models.Model):
    name = models.CharField(max_length=50, unique=True)
    slug = models.SlugField(max_length=50, unique=True)
    description = models.TextField(blank=True)

class ContextTag(models.Model):
    name = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(max_length=100, unique=True)
    description = models.TextField(blank=True)

class Language(models.Model):
    code = models.CharField(max_length=10, unique=True)  # ISO 639-1
    name = models.CharField(max_length=100)

class CultureTag(models.Model):
    name = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(max_length=100, unique=True)
    description = models.TextField(blank=True)

class Source(models.Model):
    name = models.CharField(max_length=200)
    url = models.URLField(blank=True)
    description = models.TextField(blank=True)
```

**Main Joke model:**

```python
class Joke(models.Model):
    # Content
    text = models.TextField(help_text="Full joke text for one-liners or complete jokes")
    setup = models.TextField(blank=True, help_text="Setup for two-part jokes")
    punchline = models.TextField(blank=True, help_text="Punchline for two-part jokes")

    # Foreign Keys (single value)
    format = models.ForeignKey(Format, on_delete=models.PROTECT, related_name='jokes')
    age_rating = models.ForeignKey(AgeRating, on_delete=models.PROTECT, related_name='jokes')
    language = models.ForeignKey(Language, on_delete=models.PROTECT, related_name='jokes')
    source = models.ForeignKey(Source, on_delete=models.SET_NULL, null=True, blank=True, related_name='jokes')

    # Many-to-Many (multiple values)
    tones = models.ManyToManyField(Tone, related_name='jokes')
    context_tags = models.ManyToManyField(ContextTag, related_name='jokes')
    culture_tags = models.ManyToManyField(CultureTag, related_name='jokes', blank=True)

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return self.text[:50] + ('...' if len(self.text) > 50 else '')
```

**Important:**
- Use `on_delete=PROTECT` for required FKs (prevents accidental deletion of referenced data)
- Use `on_delete=SET_NULL` for optional FK (Source) with null=True
- Add `related_name='jokes'` for reverse lookups
- Add `help_text` for admin clarity
- Add `__str__` methods to all models for admin display
  </action>
  <verify>python manage.py check --fail-level ERROR returns no errors</verify>
  <done>jokes app created, all 8 models defined in models.py, app added to INSTALLED_APPS</done>
</task>

<task type="auto">
  <name>Task 2: Generate migrations and configure Django admin</name>
  <files>jokes/admin.py, jokes/migrations/0001_initial.py</files>
  <action>
1. Generate migrations:
   ```bash
   python manage.py makemigrations jokes
   ```

2. Apply migrations:
   ```bash
   python manage.py migrate
   ```

3. Configure admin in jokes/admin.py:

```python
from django.contrib import admin
from .models import Joke, Format, AgeRating, Tone, ContextTag, Language, CultureTag, Source


@admin.register(Format)
class FormatAdmin(admin.ModelAdmin):
    list_display = ['name', 'slug']
    prepopulated_fields = {'slug': ('name',)}


@admin.register(AgeRating)
class AgeRatingAdmin(admin.ModelAdmin):
    list_display = ['name', 'slug', 'min_age']
    prepopulated_fields = {'slug': ('name',)}


@admin.register(Tone)
class ToneAdmin(admin.ModelAdmin):
    list_display = ['name', 'slug']
    prepopulated_fields = {'slug': ('name',)}


@admin.register(ContextTag)
class ContextTagAdmin(admin.ModelAdmin):
    list_display = ['name', 'slug']
    prepopulated_fields = {'slug': ('name',)}
    search_fields = ['name']


@admin.register(Language)
class LanguageAdmin(admin.ModelAdmin):
    list_display = ['code', 'name']
    search_fields = ['code', 'name']


@admin.register(CultureTag)
class CultureTagAdmin(admin.ModelAdmin):
    list_display = ['name', 'slug']
    prepopulated_fields = {'slug': ('name',)}
    search_fields = ['name']


@admin.register(Source)
class SourceAdmin(admin.ModelAdmin):
    list_display = ['name', 'url']
    search_fields = ['name']


@admin.register(Joke)
class JokeAdmin(admin.ModelAdmin):
    list_display = ['__str__', 'format', 'age_rating', 'language', 'created_at']
    list_filter = ['format', 'age_rating', 'tones', 'context_tags', 'language']
    search_fields = ['text', 'setup', 'punchline']
    filter_horizontal = ['tones', 'context_tags', 'culture_tags']
    readonly_fields = ['created_at', 'updated_at']
    fieldsets = [
        ('Content', {'fields': ['text', 'setup', 'punchline']}),
        ('Classification', {'fields': ['format', 'age_rating', 'language', 'source']}),
        ('Tags', {'fields': ['tones', 'context_tags', 'culture_tags']}),
        ('Metadata', {'fields': ['created_at', 'updated_at'], 'classes': ['collapse']}),
    ]
```

**Admin features:**
- `prepopulated_fields` auto-generates slugs from names
- `filter_horizontal` provides better M2M widget
- `list_filter` enables sidebar filtering
- `fieldsets` organizes form into logical sections
  </action>
  <verify>python manage.py migrate --check returns "No migrations to apply" AND python manage.py runserver 8001 starts without errors</verify>
  <done>Migrations created and applied, admin interface configured with filters and search for all models</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python manage.py check` passes with no errors
- [ ] `python manage.py migrate --check` shows no pending migrations
- [ ] `python manage.py runserver` starts successfully
- [ ] Admin interface accessible at /admin/ (after creating superuser if needed)
- [ ] All 8 models visible in admin
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 8 models created: Joke, Format, AgeRating, Tone, ContextTag, Language, CultureTag, Source
- Models support the three search patterns: situation-based, tone-based, audience-based
- Admin interface enables content management
- Phase 02: Data Models complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-models/02-01-SUMMARY.md` following the summary template with frontmatter.

Document:
- All models created with field details
- Relationship types (FK vs M2M)
- Admin features configured
- Any deviations from plan
</output>
