---
phase: 05-api-core
plan: 02
type: execute
---

<objective>
Create API viewsets and URL routing for jokes and lookup data.

Purpose: Expose all joke data through RESTful endpoints with search, filtering, and documentation.
Output: Working API endpoints accessible at /api/v1/ with Swagger documentation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/05-api-core/05-01-SUMMARY.md

# Key source files:
@jokes/models.py
@jokes/managers.py
@jokes/serializers.py
@JokesForProject/settings.py
@JokesForProject/urls.py

**Tech stack available:**
- Django REST Framework (from 05-01)
- drf-spectacular (from 05-01)
- django-cors-headers (from 05-01)
- JokeManager.search() for full-text search

**Established patterns:**
- JokeManager.search(query_text, filters) returns ranked QuerySet
- Filters: format, age_rating, tones, context_tags, culture_tags, language (all by slug/code)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Joke viewset with list/detail/random and search integration</name>
  <files>jokes/views.py</files>
  <action>
Create jokes/views.py with JokeViewSet:

**JokeViewSet (ReadOnlyModelViewSet):**
- queryset: Joke.objects.all()
- Use JokeListSerializer for list action, JokeSerializer for retrieve action (override get_serializer_class)

**Override list() to integrate JokeManager.search():**
- Extract query params: q (search text), format, age_rating, tones, context_tags, culture_tags, language
- For list params (tones, context_tags, culture_tags): split comma-separated values
- Build filters dict from query params
- Call Joke.objects.search(query_text=q, filters=filters)
- Paginate and return results

**Add @action for random joke:**
- @action(detail=False, methods=['get'])
- def random(self, request): get random joke using .order_by('?').first()
- Return 404 if no jokes exist
- Use JokeSerializer for full detail

**Query param examples:**
- /api/v1/jokes/?q=chicken - full-text search
- /api/v1/jokes/?format=one-liner - filter by format
- /api/v1/jokes/?tones=clean,dad-jokes - filter by multiple tones
- /api/v1/jokes/?q=why&age_rating=kid-safe - search with filter

Use drf-spectacular's @extend_schema decorator to document:
- Query parameters with descriptions
- Response schemas
  </action>
  <verify>python -c "from jokes.views import JokeViewSet; print('JokeViewSet import OK')"</verify>
  <done>JokeViewSet with list/retrieve/random actions, search integration, and query param filtering</done>
</task>

<task type="auto">
  <name>Task 2: Create lookup viewsets, URL routing, and API documentation</name>
  <files>jokes/views.py, jokes/urls.py, JokesForProject/urls.py</files>
  <action>
**Add lookup viewsets to jokes/views.py:**

Create read-only viewsets for all lookup models:
- FormatViewSet(ReadOnlyModelViewSet): queryset=Format.objects.all(), serializer_class=FormatSerializer
- AgeRatingViewSet(ReadOnlyModelViewSet): queryset=AgeRating.objects.all(), serializer_class=AgeRatingSerializer
- ToneViewSet(ReadOnlyModelViewSet): queryset=Tone.objects.all(), serializer_class=ToneSerializer
- ContextTagViewSet(ReadOnlyModelViewSet): queryset=ContextTag.objects.all(), serializer_class=ContextTagSerializer
- CultureTagViewSet(ReadOnlyModelViewSet): queryset=CultureTag.objects.all(), serializer_class=CultureTagSerializer
- LanguageViewSet(ReadOnlyModelViewSet): queryset=Language.objects.all(), serializer_class=LanguageSerializer

**Create jokes/urls.py with DRF router:**
```python
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register('jokes', views.JokeViewSet, basename='joke')
router.register('formats', views.FormatViewSet, basename='format')
router.register('age-ratings', views.AgeRatingViewSet, basename='age-rating')
router.register('tones', views.ToneViewSet, basename='tone')
router.register('context-tags', views.ContextTagViewSet, basename='context-tag')
router.register('culture-tags', views.CultureTagViewSet, basename='culture-tag')
router.register('languages', views.LanguageViewSet, basename='language')

urlpatterns = router.urls
```

**Update JokesForProject/urls.py:**
- Add versioned API path: path('api/v1/', include('jokes.urls'))
- Add drf-spectacular views:
  - path('api/schema/', SpectacularAPIView.as_view(), name='schema')
  - path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui')
  - path('api/redoc/', SpectacularRedocView.as_view(url_name='schema'), name='redoc')
  </action>
  <verify>python manage.py check && python -c "from JokesForProject.urls import urlpatterns; print(f'{len(urlpatterns)} URL patterns configured')"</verify>
  <done>All viewsets created, URLs configured at /api/v1/, API docs available at /api/docs/</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python manage.py check` returns no errors
- [ ] `python manage.py runserver` starts without errors
- [ ] GET /api/v1/jokes/ returns paginated joke list
- [ ] GET /api/v1/jokes/{id}/ returns joke detail with nested relations
- [ ] GET /api/v1/jokes/random/ returns a random joke
- [ ] GET /api/v1/jokes/?q=chicken returns search results
- [ ] GET /api/v1/jokes/?format=one-liner returns filtered results
- [ ] GET /api/v1/formats/ returns format list
- [ ] GET /api/v1/tones/ returns tone list
- [ ] GET /api/docs/ shows Swagger UI
</verification>

<success_criteria>

- JokeViewSet with list/retrieve/random actions working
- Search integration via JokeManager.search() working
- Query param filtering working (q, format, age_rating, tones, context_tags, culture_tags, language)
- All 7 lookup viewsets returning data
- URL routing configured at /api/v1/
- Swagger documentation accessible at /api/docs/
- CORS allowing frontend requests
- Phase 05: API Core complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-core/05-02-SUMMARY.md`
</output>
