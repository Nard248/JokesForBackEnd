---
phase: 06-authentication
plan: 01
type: execute
---

<objective>
Install and configure dj-rest-auth with JWT authentication support.

Purpose: Establish the core authentication infrastructure that all protected endpoints will use.
Output: dj-rest-auth + simplejwt + allauth installed and configured with secure JWT settings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-authentication/06-RESEARCH.md

# Prior phase context
@.planning/phases/05-api-core/05-01-SUMMARY.md
@.planning/phases/05-api-core/05-02-SUMMARY.md

# Key files to modify
@JokesForProject/settings.py
@requirements.txt

**Tech stack available:**
- djangorestframework 3.16.1
- drf-spectacular 0.29.0
- django-cors-headers 4.9.0
- PostgreSQL with full-text search

**Established patterns:**
- REST_FRAMEWORK configured with pagination, throttling, versioning
- Environment variables via python-dotenv
- CORS_ALLOW_ALL_ORIGINS for dev

**Constraining decisions:**
- [Phase 05-01]: URL path versioning with v1 as default
- [Phase 05-01]: Throttle rates: 100/hour anon, 1000/hour authenticated
- [RESEARCH]: Use HttpOnly cookies for JWT storage (not localStorage)
- [RESEARCH]: Enable refresh token rotation with blacklisting
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install authentication packages</name>
  <files>requirements.txt</files>
  <action>
Install dj-rest-auth with social support and djangorestframework-simplejwt:

```bash
pip install 'dj-rest-auth[with_social]' djangorestframework-simplejwt
```

This installs:
- dj-rest-auth 7.0.1 (unified auth REST endpoints)
- django-allauth (social auth, installed as dependency)
- djangorestframework-simplejwt 5.5.1 (JWT token handling)

After installing, freeze to requirements.txt:
```bash
pip freeze > requirements.txt
```

**Avoid:** Installing django-rest-auth (the old unmaintained package) - use dj-rest-auth (with hyphen).
  </action>
  <verify>pip list | grep -E "dj-rest-auth|djangorestframework-simplejwt|django-allauth" shows all three packages installed</verify>
  <done>dj-rest-auth, djangorestframework-simplejwt, and django-allauth installed. requirements.txt updated.</done>
</task>

<task type="auto">
  <name>Task 2: Configure authentication settings</name>
  <files>JokesForProject/settings.py</files>
  <action>
Update settings.py with authentication configuration. Add to existing file:

**1. Add to INSTALLED_APPS (after existing apps, before 'jokes'):**
```python
    'rest_framework.authtoken',  # Required by dj-rest-auth
    'rest_framework_simplejwt.token_blacklist',  # For refresh token blacklisting
    'dj_rest_auth',
    'django.contrib.sites',  # Required by allauth
    'allauth',
    'allauth.account',
    'allauth.socialaccount',
    'allauth.socialaccount.providers.google',
    'dj_rest_auth.registration',
```

**2. Add after INSTALLED_APPS:**
```python
SITE_ID = 1
```

**3. Add to MIDDLEWARE (after AuthenticationMiddleware):**
```python
    'allauth.account.middleware.AccountMiddleware',
```

**4. Add after MIDDLEWARE:**
```python
# Authentication backends
AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
    'allauth.account.auth_backends.AuthenticationBackend',
]
```

**5. Update REST_FRAMEWORK (add DEFAULT_AUTHENTICATION_CLASSES):**
```python
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'dj_rest_auth.jwt_auth.JWTCookieAuthentication',
    ],
    # ... keep existing pagination, throttling, versioning settings ...
}
```

**6. Add dj-rest-auth settings at end of file:**
```python
# dj-rest-auth settings
# https://dj-rest-auth.readthedocs.io/en/latest/configuration.html

REST_AUTH = {
    'USE_JWT': True,
    'JWT_AUTH_COOKIE': 'jokes-access-token',
    'JWT_AUTH_REFRESH_COOKIE': 'jokes-refresh-token',
    'JWT_AUTH_HTTPONLY': True,
    'JWT_AUTH_SECURE': not DEBUG,  # True in production (HTTPS), False for local dev
    'JWT_AUTH_SAMESITE': 'Lax',
    'SESSION_LOGIN': False,  # Disable session auth, use JWT only
}
```

**7. Add Simple JWT settings:**
```python
# Simple JWT settings
# https://django-rest-framework-simplejwt.readthedocs.io/en/latest/settings.html

from datetime import timedelta

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=15),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': True,
    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'AUTH_HEADER_TYPES': ('Bearer',),
}
```

**8. Add allauth settings:**
```python
# django-allauth settings
# https://docs.allauth.org/en/latest/account/configuration.html

ACCOUNT_EMAIL_REQUIRED = True
ACCOUNT_AUTHENTICATION_METHOD = 'email'
ACCOUNT_EMAIL_VERIFICATION = 'optional'  # 'mandatory' for production
ACCOUNT_UNIQUE_EMAIL = True
ACCOUNT_USERNAME_REQUIRED = False  # Use email as username

# Google OAuth settings
SOCIALACCOUNT_PROVIDERS = {
    'google': {
        'SCOPE': ['profile', 'email'],
        'AUTH_PARAMS': {'access_type': 'offline'},
        'OAUTH_PKCE_ENABLED': True,
    }
}

# Google OAuth credentials (from environment)
GOOGLE_OAUTH_CALLBACK_URL = os.getenv('GOOGLE_OAUTH_CALLBACK_URL', 'http://localhost:5173/auth/google/callback')
```

**CRITICAL:** Move the `from datetime import timedelta` to the top of the file with other imports.

**Avoid:**
- Putting JWT_AUTH_SECURE = True for local dev (breaks without HTTPS)
- Setting ACCOUNT_EMAIL_VERIFICATION = 'mandatory' before email sending is configured
- Storing Google OAuth client ID/secret in settings directly (use environment variables)
  </action>
  <verify>python manage.py check returns no errors</verify>
  <done>settings.py configured with all auth settings. Django check passes with no errors.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip list | grep -E "dj-rest-auth|djangorestframework-simplejwt|django-allauth"` shows all packages
- [ ] `python manage.py check` returns no errors
- [ ] settings.py contains REST_AUTH, SIMPLE_JWT, and allauth settings
- [ ] SITE_ID = 1 is set
- [ ] AccountMiddleware is in MIDDLEWARE
</verification>

<success_criteria>
- All authentication packages installed
- settings.py properly configured
- Django check passes
- No import errors when running server
</success_criteria>

<output>
After completion, create `.planning/phases/06-authentication/06-01-SUMMARY.md` following the summary template.
</output>
