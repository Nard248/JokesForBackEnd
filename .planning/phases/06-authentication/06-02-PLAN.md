---
phase: 06-authentication
plan: 02
type: execute
---

<objective>
Configure authentication URL routing, create Google OAuth view, and run migrations.

Purpose: Complete the auth API endpoints and database setup so auth flows work end-to-end.
Output: Working auth endpoints at /api/v1/auth/*, database tables created, Site object configured.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-authentication/06-RESEARCH.md

# Prior plan in this phase
@.planning/phases/06-authentication/06-01-SUMMARY.md

# Key files to modify
@JokesForProject/urls.py
@jokes/views.py

**Tech stack available:**
- dj-rest-auth 7.0.1 with JWT mode
- django-allauth with Google provider
- djangorestframework-simplejwt with token blacklisting

**Constraining decisions:**
- [RESEARCH]: Use SocialLoginView pattern for Google OAuth
- [05-02]: API routes at /api/v1/ prefix
- [RESEARCH]: callback_url should match frontend URL for SPA OAuth flow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure authentication URL routing</name>
  <files>JokesForProject/urls.py</files>
  <action>
Add auth URL routes to urls.py. Import and add patterns:

**1. Add import at top:**
```python
from jokes.views import GoogleLogin
```

**2. Add auth URL patterns (before API Documentation section):**
```python
    # Authentication
    path('api/v1/auth/', include('dj_rest_auth.urls')),
    path('api/v1/auth/registration/', include('dj_rest_auth.registration.urls')),
    path('api/v1/auth/google/', GoogleLogin.as_view(), name='google_login'),
```

This provides:
- POST /api/v1/auth/login/ - Email/password login
- POST /api/v1/auth/logout/ - Logout (invalidate token)
- POST /api/v1/auth/password/reset/ - Request password reset
- POST /api/v1/auth/password/reset/confirm/ - Confirm password reset
- POST /api/v1/auth/password/change/ - Change password (authenticated)
- GET /api/v1/auth/user/ - Get current user
- PUT/PATCH /api/v1/auth/user/ - Update current user
- POST /api/v1/auth/token/verify/ - Verify JWT token
- POST /api/v1/auth/token/refresh/ - Refresh JWT token
- POST /api/v1/auth/registration/ - Register new user
- POST /api/v1/auth/google/ - Google OAuth login

**Note:** The GoogleLogin view import will fail until Task 2 creates it. This is expected - create the view before testing.
  </action>
  <verify>After Task 2, python manage.py check returns no import errors</verify>
  <done>Auth URL patterns added to urls.py with all dj-rest-auth endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Create Google OAuth login view</name>
  <files>jokes/views.py</files>
  <action>
Add GoogleLogin view to jokes/views.py. Add at the end of the file:

**1. Add imports at top of file (after existing imports):**
```python
from allauth.socialaccount.providers.google.views import GoogleOAuth2Adapter
from allauth.socialaccount.providers.oauth2.client import OAuth2Client
from dj_rest_auth.registration.views import SocialLoginView
from django.conf import settings
```

**2. Add view class at end of file:**
```python
class GoogleLogin(SocialLoginView):
    """
    Google OAuth2 login endpoint.

    Accepts authorization code from frontend OAuth flow and returns JWT tokens.
    Frontend should redirect user to Google OAuth, receive code, then POST it here.

    Request body:
    {
        "code": "authorization_code_from_google"
    }

    Response:
    {
        "access": "jwt_access_token",  # Also set as HttpOnly cookie
        "refresh": "jwt_refresh_token",  # Also set as HttpOnly cookie
        "user": { ... }
    }
    """
    adapter_class = GoogleOAuth2Adapter
    callback_url = settings.GOOGLE_OAUTH_CALLBACK_URL
    client_class = OAuth2Client
```

**Note:** This view expects the frontend to handle the OAuth redirect flow:
1. Frontend redirects user to Google OAuth consent page
2. Google redirects back to frontend callback URL with authorization code
3. Frontend POSTs the code to this endpoint
4. Backend exchanges code for tokens, creates/updates user, returns JWT

**Avoid:**
- Using adapter_class string instead of class reference
- Hardcoding callback_url (get from settings for flexibility)
  </action>
  <verify>python manage.py check returns no errors. grep -n "GoogleLogin" jokes/views.py shows the view class.</verify>
  <done>GoogleLogin view created in jokes/views.py with proper adapter and OAuth2 client configuration.</done>
</task>

<task type="auto">
  <name>Task 3: Run migrations and configure Site</name>
  <files>Database migrations</files>
  <action>
Run migrations and create the default Site object required by allauth.

**1. Run migrations:**
```bash
python manage.py migrate
```

This creates tables for:
- django.contrib.sites (Site model)
- allauth.account (EmailAddress, etc.)
- allauth.socialaccount (SocialApp, SocialAccount, SocialToken)
- rest_framework.authtoken (Token)
- rest_framework_simplejwt.token_blacklist (OutstandingToken, BlacklistedToken)

**2. Update the default Site object:**
```bash
python manage.py shell -c "
from django.contrib.sites.models import Site
site = Site.objects.get(pk=1)
site.domain = 'localhost:8000'
site.name = 'Jokes For (Development)'
site.save()
print(f'Site updated: {site.domain} - {site.name}')
"
```

**Avoid:**
- Forgetting to run migrations (allauth will fail with "Site matching query does not exist")
- Leaving Site domain as "example.com" (causes OAuth redirect issues)
  </action>
  <verify>python manage.py showmigrations | grep -E "(sites|account|socialaccount|authtoken|token_blacklist)" shows all migrations applied ([X])</verify>
  <done>All auth-related migrations applied. Site object configured for localhost development.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python manage.py check` returns no errors
- [ ] `python manage.py showmigrations` shows all migrations applied
- [ ] `curl http://localhost:8000/api/v1/auth/login/ -X POST` returns 400 (missing credentials) not 404
- [ ] `curl http://localhost:8000/api/v1/auth/registration/ -X POST` returns 400 (missing data) not 404
- [ ] Site object domain is "localhost:8000"
</verification>

<success_criteria>
- All auth URL patterns accessible
- GoogleLogin view created and importable
- Database migrations applied
- Site object configured for development
- Auth endpoints return proper error responses (not 404)
</success_criteria>

<output>
After completion, create `.planning/phases/06-authentication/06-02-SUMMARY.md` following the summary template.
</output>
