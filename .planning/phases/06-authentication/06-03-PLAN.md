---
phase: 06-authentication
plan: 03
type: execute
---

<objective>
Configure Google OAuth credentials and verify complete authentication flow.

Purpose: Enable Google OAuth login and verify all auth flows work end-to-end.
Output: Working Google OAuth integration, verified email/password registration, JWT token flow confirmed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-authentication/06-RESEARCH.md

# Prior plans in this phase
@.planning/phases/06-authentication/06-01-SUMMARY.md
@.planning/phases/06-authentication/06-02-SUMMARY.md

# Key files
@.env
@JokesForProject/settings.py

**Tech stack available:**
- dj-rest-auth with JWT mode configured
- django-allauth with Google provider
- Auth endpoints at /api/v1/auth/*

**Constraining decisions:**
- [RESEARCH]: Google OAuth requires Google Cloud Console project with OAuth credentials
- [RESEARCH]: Callback URL must exactly match what's registered in Google Console
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Google OAuth credentials in Google Cloud Console</action>
  <instructions>
I've configured dj-rest-auth and django-allauth for Google OAuth.
Now you need to create OAuth credentials in Google Cloud Console:

**Steps:**

1. Go to https://console.cloud.google.com/
2. Create a new project or select existing one
3. Navigate to "APIs & Services" → "OAuth consent screen"
   - Choose "External" user type
   - Fill in app name: "Jokes For"
   - Add your email as support email
   - Add authorized domain if you have one (skip for local dev)
   - Save

4. Navigate to "APIs & Services" → "Credentials"
   - Click "Create Credentials" → "OAuth client ID"
   - Application type: "Web application"
   - Name: "Jokes For Web Client"
   - Authorized JavaScript origins:
     - `http://localhost:8000`
     - `http://localhost:5173` (React dev server)
   - Authorized redirect URIs:
     - `http://localhost:5173/auth/google/callback` (frontend callback)
   - Click "Create"

5. Copy the **Client ID** and **Client Secret** from the popup

**When done, tell me the Client ID and Client Secret** (I'll add them to .env securely).
  </instructions>
  <verification>You provide Client ID and Client Secret values</verification>
  <resume-signal>Provide the Google OAuth Client ID and Client Secret to continue</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Add OAuth credentials to environment and create SocialApp</name>
  <files>.env, Django admin</files>
  <action>
Add the provided Google OAuth credentials to .env and create SocialApp in database.

**1. Add to .env file:**
```
GOOGLE_CLIENT_ID=<provided_client_id>
GOOGLE_CLIENT_SECRET=<provided_client_secret>
```

**2. Create SocialApp via Django shell:**
```bash
python manage.py shell -c "
from allauth.socialaccount.models import SocialApp
from django.contrib.sites.models import Site

# Create or update Google social app
app, created = SocialApp.objects.update_or_create(
    provider='google',
    defaults={
        'name': 'Google',
        'client_id': '<provided_client_id>',
        'secret': '<provided_client_secret>',
    }
)

# Associate with site
site = Site.objects.get(pk=1)
app.sites.add(site)

print(f'Google SocialApp {\"created\" if created else \"updated\"}: {app.client_id[:20]}...')
"
```

**Note:** Replace `<provided_client_id>` and `<provided_client_secret>` with actual values from checkpoint.

**Avoid:**
- Committing .env to git (should be in .gitignore)
- Storing credentials only in .env without SocialApp (allauth needs both)
  </action>
  <verify>python manage.py shell -c "from allauth.socialaccount.models import SocialApp; print(SocialApp.objects.filter(provider='google').exists())" returns True</verify>
  <done>Google OAuth credentials added to .env and SocialApp created in database.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete JWT authentication system with email/password registration and Google OAuth</what-built>
  <how-to-verify>
**Start the development server:**
```bash
python manage.py runserver
```

**1. Test email/password registration:**
```bash
curl -X POST http://localhost:8000/api/v1/auth/registration/ \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password1": "TestPass123!", "password2": "TestPass123!"}'
```
Expected: 201 response with user data and Set-Cookie headers for JWT tokens

**2. Test login:**
```bash
curl -X POST http://localhost:8000/api/v1/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "TestPass123!"}'
```
Expected: 200 response with access token and Set-Cookie headers

**3. Test token refresh:**
```bash
curl -X POST http://localhost:8000/api/v1/auth/token/refresh/ \
  -H "Content-Type: application/json" \
  -d '{"refresh": "<refresh_token_from_login>"}'
```
Expected: 200 response with new access token

**4. Test authenticated endpoint:**
```bash
curl http://localhost:8000/api/v1/auth/user/ \
  -H "Authorization: Bearer <access_token_from_login>"
```
Expected: 200 response with user details

**5. Check Swagger docs:**
Visit http://localhost:8000/api/docs/
Confirm auth endpoints appear in the documentation

**6. (Optional) Test Google OAuth:**
The Google OAuth flow requires a frontend. For now, confirm the endpoint exists:
```bash
curl -X POST http://localhost:8000/api/v1/auth/google/ \
  -H "Content-Type: application/json" \
  -d '{"code": "invalid"}'
```
Expected: 400 error (invalid code), NOT 404 (endpoint exists)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Email/password registration creates user and returns JWT
- [ ] Login returns JWT tokens in cookies and response
- [ ] Token refresh works
- [ ] Authenticated endpoint returns user data
- [ ] Google OAuth endpoint exists (even if not fully testable without frontend)
- [ ] Swagger docs show auth endpoints
</verification>

<success_criteria>
- All auth endpoints functional
- JWT tokens returned in HttpOnly cookies
- Token refresh with rotation works
- Google OAuth SocialApp configured
- Phase 06: Authentication complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-authentication/06-03-SUMMARY.md` following the summary template.

Include in summary:
- Authentication endpoints available
- JWT configuration (token lifetimes, cookie settings)
- Google OAuth status (configured, ready for frontend integration)
- Any issues encountered during verification
</output>
