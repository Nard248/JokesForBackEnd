---
phase: 07-user-preferences
plan: 01
type: execute
---

<objective>
Create UserPreference model linked to User with humor/context preferences and notification settings.

Purpose: Enable personalized joke recommendations and daily joke delivery based on user preferences.
Output: UserPreference Django model with migration, auto-creation signal, and admin interface.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (from frontmatter):
@.planning/phases/06-authentication/06-03-SUMMARY.md

# Key existing files:
@jokes/models.py

**Tech stack available:** Django 5.x, DRF, djangorestframework-simplejwt, django-allauth
**Established patterns:**
- PROTECT on_delete for required FK relationships
- SET_NULL on_delete for optional FK
- Lookup tables with slug fields for URL-friendly identifiers
- Custom managers for complex queries

**Constraining decisions:**
- Phase 06: Uses Django's default User model (no custom AUTH_USER_MODEL)
- Phase 06: Email-based login (email is the identifier)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserPreference model</name>
  <files>jokes/models.py, jokes/migrations/XXXX_userpreference.py</files>
  <action>
Add UserPreference model to jokes/models.py with:

**Fields:**
- user: OneToOneField to settings.AUTH_USER_MODEL (on_delete=CASCADE)
- preferred_tones: ManyToManyField to Tone (blank=True, related_name='preferred_by')
- preferred_contexts: ManyToManyField to ContextTag (blank=True, related_name='preferred_by')
- preferred_age_rating: ForeignKey to AgeRating (null=True, blank=True, on_delete=SET_NULL)
- preferred_language: ForeignKey to Language (null=True, blank=True, on_delete=SET_NULL)
- notification_enabled: BooleanField (default=False)
- notification_time: TimeField (null=True, blank=True, help_text="Time for daily joke notification")
- onboarding_completed: BooleanField (default=False)
- created_at: DateTimeField (auto_now_add=True)
- updated_at: DateTimeField (auto_now=True)

**Import:** `from django.conf import settings` for AUTH_USER_MODEL reference (not direct User import).

**Meta:** Add verbose_name and verbose_name_plural.

Run `python manage.py makemigrations jokes` to create migration.
  </action>
  <verify>python manage.py makemigrations --check --dry-run jokes returns "No changes detected" (migration already created)</verify>
  <done>UserPreference model exists in jokes/models.py with all specified fields, migration file created</done>
</task>

<task type="auto">
  <name>Task 2: Add signal for auto-creation and migrate</name>
  <files>jokes/signals.py, jokes/apps.py, jokes/migrations/XXXX_userpreference.py</files>
  <action>
Create jokes/signals.py with post_save signal to auto-create UserPreference when User is created:

```python
from django.conf import settings
from django.db.models.signals import post_save
from django.dispatch import receiver

@receiver(post_save, sender=settings.AUTH_USER_MODEL)
def create_user_preference(sender, instance, created, **kwargs):
    if created:
        from .models import UserPreference
        UserPreference.objects.create(user=instance)
```

Update jokes/apps.py to import signals in ready() method:

```python
def ready(self):
    import jokes.signals  # noqa: F401
```

Run `python manage.py migrate` to apply migration.
  </action>
  <verify>python manage.py migrate succeeds; python manage.py shell -c "from django.contrib.auth import get_user_model; from jokes.models import UserPreference; User = get_user_model(); u = User.objects.create_user('test_signal@test.com', 'test_signal@test.com', 'testpass123'); print(UserPreference.objects.filter(user=u).exists()); u.delete()" prints "True"</verify>
  <done>Signal creates UserPreference on User creation, migration applied successfully</done>
</task>

<task type="auto">
  <name>Task 3: Add admin interface for UserPreference</name>
  <files>jokes/admin.py</files>
  <action>
Add UserPreferenceAdmin to jokes/admin.py:

```python
@admin.register(UserPreference)
class UserPreferenceAdmin(admin.ModelAdmin):
    list_display = ['user', 'preferred_age_rating', 'notification_enabled', 'onboarding_completed', 'created_at']
    list_filter = ['notification_enabled', 'onboarding_completed', 'preferred_age_rating']
    search_fields = ['user__email']
    filter_horizontal = ['preferred_tones', 'preferred_contexts']
    readonly_fields = ['created_at', 'updated_at']
```

Import UserPreference at top of admin.py.
  </action>
  <verify>python manage.py check returns no errors; admin site loads at /admin/jokes/userpreference/</verify>
  <done>UserPreference visible in Django admin with filters and search</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python manage.py makemigrations --check` shows no pending migrations
- [ ] `python manage.py check` passes with no errors
- [ ] UserPreference model has all required fields
- [ ] Signal auto-creates UserPreference for new users
- [ ] Admin interface shows UserPreference with proper filtering
</verification>

<success_criteria>

- All tasks completed
- UserPreference model exists with OneToOne link to User
- Migration applied successfully
- Signal creates preference record on user creation
- Admin interface functional
</success_criteria>

<output>
After completion, create `.planning/phases/07-user-preferences/07-01-SUMMARY.md`
</output>
