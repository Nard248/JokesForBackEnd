---
phase: 07-user-preferences
plan: 02
type: execute
---

<objective>
Create preference API endpoints for getting, updating preferences and tracking onboarding status.

Purpose: Enable frontend to manage user preferences and implement onboarding flow.
Output: UserPreference serializers and ViewSet with get/update/onboarding endpoints.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/07-user-preferences/07-01-SUMMARY.md

# Key existing files:
@jokes/serializers.py
@jokes/views.py
@jokes/urls.py

**Tech stack available:** Django 5.x, DRF 3.16, dj-rest-auth, simplejwt
**Established patterns:**
- ReadOnlyModelViewSet for lookup endpoints
- Nested serializers for detail views
- DRF DefaultRouter for URL generation
- JWT authentication via HttpOnly cookies

**API structure:** /api/v1/ prefix, versioned endpoints
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserPreference serializers</name>
  <files>jokes/serializers.py</files>
  <action>
Add to jokes/serializers.py:

**UserPreferenceSerializer** (for read/detail):
- Fields: id, preferred_tones, preferred_contexts, preferred_age_rating, preferred_language, notification_enabled, notification_time, onboarding_completed, created_at, updated_at
- Use nested ToneSerializer, ContextTagSerializer, AgeRatingSerializer, LanguageSerializer for read operations
- Add read_only=True to nested serializers

**UserPreferenceUpdateSerializer** (for write/update):
- Fields: preferred_tones, preferred_contexts, preferred_age_rating, preferred_language, notification_enabled, notification_time, onboarding_completed
- Use PrimaryKeyRelatedField for FK/M2M fields (accept IDs for write)
- Make all fields optional (blank=True already on model)
- Add validation: notification_time required if notification_enabled=True

Import UserPreference model at top.
  </action>
  <verify>python manage.py shell -c "from jokes.serializers import UserPreferenceSerializer, UserPreferenceUpdateSerializer; print('Serializers imported successfully')"</verify>
  <done>Both serializers exist and import without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create UserPreference ViewSet with endpoints</name>
  <files>jokes/views.py</files>
  <action>
Add UserPreferenceViewSet to jokes/views.py:

```python
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

class UserPreferenceViewSet(viewsets.GenericViewSet):
    """
    User preference management.

    Endpoints:
    - GET /api/v1/preferences/me/ - Get current user's preferences
    - PATCH /api/v1/preferences/me/ - Update current user's preferences
    - POST /api/v1/preferences/complete-onboarding/ - Mark onboarding as complete
    """
    permission_classes = [IsAuthenticated]

    def get_serializer_class(self):
        if self.action in ['update_preferences']:
            return UserPreferenceUpdateSerializer
        return UserPreferenceSerializer

    @action(detail=False, methods=['get', 'patch'], url_path='me')
    def me(self, request):
        """Get or update current user's preferences."""
        preference = request.user.userpreference

        if request.method == 'GET':
            serializer = UserPreferenceSerializer(preference)
            return Response(serializer.data)

        # PATCH
        serializer = UserPreferenceUpdateSerializer(preference, data=request.data, partial=True)
        serializer.is_valid(raise_exception=True)
        serializer.save()
        return Response(UserPreferenceSerializer(preference).data)

    @action(detail=False, methods=['post'], url_path='complete-onboarding')
    def complete_onboarding(self, request):
        """Mark onboarding as complete."""
        preference = request.user.userpreference
        preference.onboarding_completed = True
        preference.save(update_fields=['onboarding_completed', 'updated_at'])
        return Response({'status': 'onboarding_completed', 'onboarding_completed': True})
```

Import UserPreference, UserPreferenceSerializer, UserPreferenceUpdateSerializer.
Use from rest_framework.permissions import IsAuthenticated.
  </action>
  <verify>python manage.py shell -c "from jokes.views import UserPreferenceViewSet; print('ViewSet imported successfully')"</verify>
  <done>UserPreferenceViewSet exists with me and complete_onboarding actions</done>
</task>

<task type="auto">
  <name>Task 3: Register URL routes and verify endpoints</name>
  <files>jokes/urls.py</files>
  <action>
Update jokes/urls.py to register UserPreferenceViewSet:

```python
router.register(r'preferences', UserPreferenceViewSet, basename='preferences')
```

Note: basename='preferences' is required since ViewSet doesn't have queryset attribute.

Verify the endpoint structure matches:
- GET /api/v1/preferences/me/
- PATCH /api/v1/preferences/me/
- POST /api/v1/preferences/complete-onboarding/
  </action>
  <verify>
python manage.py shell -c "
from django.urls import reverse
print('me:', reverse('preferences-me'))
print('complete-onboarding:', reverse('preferences-complete-onboarding'))
"
  </verify>
  <done>All preference endpoints registered and accessible at correct URLs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python manage.py check` passes with no errors
- [ ] Serializers handle read (nested) and write (PK) correctly
- [ ] GET /api/v1/preferences/me/ returns 401 for unauthenticated
- [ ] All endpoints appear in /api/docs/ Swagger UI
- [ ] Authenticated requests work with JWT token
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- GET /api/v1/preferences/me/ returns user preferences (authenticated)
- PATCH /api/v1/preferences/me/ updates preferences
- POST /api/v1/preferences/complete-onboarding/ marks onboarding done
- Phase 07: User Preferences complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-user-preferences/07-02-SUMMARY.md`
</output>
