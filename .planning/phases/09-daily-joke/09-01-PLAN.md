---
phase: 09-daily-joke
plan: 01
type: execute
---

<objective>
Set up Celery infrastructure with Redis broker for scheduled task execution.

Purpose: Enable background task processing and periodic scheduling required for daily joke generation.
Output: Working Celery configuration with Redis, ready for task definition.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-daily-joke/09-RESEARCH.md

**Prior phase context:**
@.planning/phases/07-user-preferences/07-01-SUMMARY.md

**Key files:**
@JokesForProject/settings.py
@requirements.txt

**Tech stack available:**
- Django 5.2.10 + DRF
- PostgreSQL with full-text search
- JWT authentication (simplejwt)
- UserPreference model with notification_enabled, notification_time

**Constraining decisions:**
- Phase 01-02: Environment variables via .env files
- RESEARCH.md: Use Celery 5.6.2 + django-celery-beat 2.8.1 + Redis 7.1.0
- RESEARCH.md: DON'T hand-roll task scheduling (use Celery Beat)

**Patterns established:**
- Environment-based configuration (12-factor app)
- AppConfig.ready() for signal imports
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Celery packages and update requirements</name>
  <files>requirements.txt</files>
  <action>
Install Celery ecosystem packages:
- celery (5.6.2 or latest compatible)
- redis (7.1.0 or latest compatible)
- django-celery-beat (2.8.1 or latest compatible)
- django-celery-results (2.5.1 or latest compatible)

Run: pip install celery redis django-celery-beat django-celery-results

Update requirements.txt with installed versions using pip freeze filtering.

Do NOT install flower yet (monitoring tool, not needed for MVP).
Do NOT install scikit-surprise or onesignal (per RESEARCH.md recommendation to defer).
  </action>
  <verify>pip list | grep -E "(celery|redis|django-celery)" shows all packages installed</verify>
  <done>celery, redis, django-celery-beat, django-celery-results in requirements.txt with pinned versions</done>
</task>

<task type="auto">
  <name>Task 2: Create Celery app configuration</name>
  <files>JokesForProject/celery.py, JokesForProject/__init__.py</files>
  <action>
Create JokesForProject/celery.py with standard Django-Celery setup:

```python
import os
from celery import Celery

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'JokesForProject.settings')

app = Celery('JokesForProject')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()
```

Update JokesForProject/__init__.py to import Celery app at startup:

```python
from .celery import app as celery_app

__all__ = ('celery_app',)
```

This ensures Celery app is loaded when Django starts, enabling @shared_task decorator to work.
  </action>
  <verify>python -c "from JokesForProject.celery import app; print(app)" outputs Celery app object</verify>
  <done>celery.py created, __init__.py updated, Celery app importable</done>
</task>

<task type="auto">
  <name>Task 3: Configure Celery settings and register apps</name>
  <files>JokesForProject/settings.py, .env, .env.example</files>
  <action>
Add Celery configuration to settings.py:

```python
# Celery Configuration
CELERY_BROKER_URL = os.environ.get('CELERY_BROKER_URL', 'redis://localhost:6379/0')
CELERY_RESULT_BACKEND = os.environ.get('CELERY_RESULT_BACKEND', 'redis://localhost:6379/0')
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'UTC'
CELERY_BEAT_SCHEDULER = 'django_celery_beat.schedulers:DatabaseScheduler'
```

Add to INSTALLED_APPS:
- 'django_celery_beat'
- 'django_celery_results'

Update .env with:
```
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

Update .env.example with same variables (documented).

Run migrations for django_celery_beat and django_celery_results:
python manage.py migrate
  </action>
  <verify>python manage.py check passes, python manage.py showmigrations shows django_celery_beat/results applied</verify>
  <done>Celery settings configured, beat/results apps registered, migrations applied</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip list | grep -E "(celery|redis|django-celery)"` shows all 4 packages
- [ ] `python manage.py check` passes with no errors
- [ ] `python -c "from JokesForProject.celery import app; print(app)"` succeeds
- [ ] `python manage.py showmigrations django_celery_beat` shows migrations applied
- [ ] requirements.txt has celery, redis, django-celery-beat, django-celery-results
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Celery infrastructure ready for task definition
- No Django errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/09-daily-joke/09-01-SUMMARY.md`
</output>
