---
phase: 10-sharing
plan: 01
type: execute
---

<objective>
Create JokeRating model and rating API endpoint for thumbs up/down voting.

Purpose: Enable users to rate jokes, feeding data into the recommendation system and surfacing the best content.
Output: JokeRating model with migration, rating API endpoint at POST /api/v1/jokes/{id}/rate/
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-sharing/10-CONTEXT.md
@.planning/phases/10-sharing/10-RESEARCH.md

# Prior phase context
@.planning/phases/05-api-core/05-02-SUMMARY.md - JokeViewSet pattern, DRF routing

# Current source files
@jokes/models.py - Add JokeRating model here
@jokes/views.py - Add rate() action to JokeViewSet
@jokes/serializers.py - Add JokeRatingSerializer

**Established patterns:**
- DRF ViewSets with @action decorators for custom endpoints
- Separate read/write serializers when needed
- unique_together constraint for one-per-user relationships
- CASCADE on_delete for user-owned data

**Key decisions from research:**
- Binary rating (1/-1) for thumbs up/down instead of 5-star scale
- Rating should be updatable (update_or_create pattern)
- Return joke's aggregate score after rating

**Tech stack:**
- Django REST Framework already configured
- PostgreSQL with Django ORM
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JokeRating model with migration</name>
  <files>jokes/models.py, jokes/migrations/XXXX_jokerating.py, jokes/admin.py</files>
  <action>
Add JokeRating model to jokes/models.py:
- user FK to settings.AUTH_USER_MODEL with CASCADE
- joke FK to Joke with CASCADE and related_name='ratings'
- rating SmallIntegerField with choices [(1, 'Like'), (-1, 'Dislike')]
- created_at DateTimeField auto_now_add
- updated_at DateTimeField auto_now
- unique_together on [user, joke] to enforce one rating per user per joke

Add Meta class with ordering = ['-created_at'] and indexes on user and joke.

In jokes/admin.py, register JokeRatingAdmin with:
- list_display: user, joke (truncated), rating, created_at
- list_filter: rating, created_at
- search_fields: user__email, joke__text
- raw_id_fields: joke (for performance with many jokes)

Generate migration with makemigrations and apply with migrate.
  </action>
  <verify>python manage.py showmigrations jokes shows new migration applied; python manage.py shell -c "from jokes.models import JokeRating; print(JokeRating._meta.fields)" shows fields</verify>
  <done>JokeRating model exists with user/joke FKs, rating field, unique_together constraint, admin registered, migration applied</done>
</task>

<task type="auto">
  <name>Task 2: Add rating API endpoint to JokeViewSet</name>
  <files>jokes/serializers.py, jokes/views.py</files>
  <action>
In jokes/serializers.py, add JokeRatingSerializer:
```python
class JokeRatingSerializer(serializers.ModelSerializer):
    class Meta:
        model = JokeRating
        fields = ['id', 'rating', 'created_at', 'updated_at']
        read_only_fields = ['id', 'created_at', 'updated_at']
```

In jokes/views.py, import JokeRating and Sum from django.db.models.

Add rate() action to JokeViewSet:
```python
@extend_schema(
    description='Rate a joke with thumbs up (1) or thumbs down (-1). Updates existing rating if present.',
    request={'application/json': {'type': 'object', 'properties': {'rating': {'type': 'integer', 'enum': [1, -1]}}}},
    responses={200: {'type': 'object', 'properties': {
        'rating': {'type': 'integer'},
        'created': {'type': 'boolean'},
        'joke_score': {'type': 'integer'}
    }}},
)
@action(detail=True, methods=['post'], permission_classes=[IsAuthenticated])
def rate(self, request, pk=None):
    """Rate a joke: POST /api/v1/jokes/{id}/rate/ with {"rating": 1} or {"rating": -1}"""
    joke = self.get_object()
    rating_value = request.data.get('rating')

    if rating_value not in [1, -1]:
        return Response(
            {'error': 'Rating must be 1 (like) or -1 (dislike)'},
            status=status.HTTP_400_BAD_REQUEST
        )

    rating, created = JokeRating.objects.update_or_create(
        user=request.user,
        joke=joke,
        defaults={'rating': rating_value}
    )

    # Calculate aggregate score
    score = joke.ratings.aggregate(score=Sum('rating'))['score'] or 0

    return Response({
        'rating': rating.rating,
        'created': created,
        'joke_score': score
    })
```

Also add get_rating action to check current user's rating for a joke:
```python
@extend_schema(
    description='Get current user\'s rating for this joke, or null if not rated.',
    responses={200: JokeRatingSerializer},
)
@action(detail=True, methods=['get'], permission_classes=[IsAuthenticated], url_path='my-rating')
def get_rating(self, request, pk=None):
    """Get user's rating for a joke: GET /api/v1/jokes/{id}/my-rating/"""
    joke = self.get_object()
    try:
        rating = JokeRating.objects.get(user=request.user, joke=joke)
        return Response(JokeRatingSerializer(rating).data)
    except JokeRating.DoesNotExist:
        return Response({'rating': None})
```
  </action>
  <verify>curl -X POST http://localhost:8000/api/v1/jokes/1/rate/ -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -d '{"rating": 1}' returns 200 with rating, created, joke_score; Swagger at /api/docs/ shows new endpoints</verify>
  <done>POST /api/v1/jokes/{id}/rate/ endpoint works, returns rating and joke_score; GET /api/v1/jokes/{id}/my-rating/ returns user's rating; endpoints documented in Swagger</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] JokeRating model exists with proper fields and constraints
- [ ] Migration applied successfully
- [ ] Admin interface shows JokeRating model
- [ ] POST /api/v1/jokes/{id}/rate/ accepts rating 1 or -1
- [ ] Returns 400 for invalid ratings
- [ ] Returns aggregate joke_score
- [ ] GET /api/v1/jokes/{id}/my-rating/ returns user's rating
- [ ] IsAuthenticated permission enforced on both endpoints
- [ ] Swagger documentation shows new endpoints
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors in runserver output
- Rating can be created and updated
- Aggregate score calculation works
</success_criteria>

<output>
After completion, create `.planning/phases/10-sharing/10-01-SUMMARY.md`
</output>
