---
phase: 10-sharing
plan: 02
type: execute
---

<objective>
Create share card infrastructure with SVG templates and CairoSVG PNG generation.

Purpose: Generate beautiful, themed share cards for jokes that look great on social media platforms.
Output: SVG templates for different joke tones, share_image field on Joke model, automatic generation on save.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-sharing/10-CONTEXT.md
@.planning/phases/10-sharing/10-RESEARCH.md

# Prior phase context
@.planning/phases/02-data-models/02-01-SUMMARY.md - Joke model structure

# Current source files
@jokes/models.py - Add share_image field to Joke model
@jokes/templates/ - Create share_cards/ directory with SVG templates

**Research findings (from 10-RESEARCH.md):**
- Use SVG templates + CairoSVG for PNG conversion (Lincoln Loop pattern)
- 1200 x 630 pixels is universal safe size for all platforms
- Use Django template system to render SVG with dynamic content
- SVG doesn't auto-wrap text - use wordwrap filter with tspan elements
- Pre-generate images on save, don't generate on request
- Store in ImageField, only regenerate when text changes

**Patterns from research:**
- Template selection based on joke's primary tone
- Detect text changes to avoid unnecessary regeneration
- Keep SVG simple - CairoSVG has limitations with advanced features
- Use system fonts (Inter or similar) - no embedded fonts

**System dependency:**
- CairoSVG requires Cairo library: macOS `brew install cairo`, Linux `apt-get install libcairo2-dev`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CairoSVG and create SVG templates</name>
  <files>requirements.txt, jokes/templates/jokes/share_cards/base_card.svg, jokes/templates/jokes/share_cards/dad_joke.svg, jokes/templates/jokes/share_cards/dark_humor.svg, jokes/templates/jokes/share_cards/pun.svg</files>
  <action>
Install CairoSVG:
```bash
pip install cairosvg
pip freeze | grep -i cairo >> requirements.txt
```

Create directory structure:
```bash
mkdir -p jokes/templates/jokes/share_cards
```

Create base_card.svg template (dark theme, red accent):
```xml
{% load mathfilters %}
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 630">
  <!-- Background -->
  <rect width="1200" height="630" fill="#1a1a2e"/>

  <!-- Brand stripe -->
  <rect y="580" width="1200" height="50" fill="#e94560"/>

  <!-- Logo/brand text -->
  <text x="60" y="615" fill="white" font-family="Inter, Arial, sans-serif" font-size="24" font-weight="600">
    JokesFor.com
  </text>

  <!-- Joke type badge -->
  {% if badge_text %}
  <rect x="1020" y="590" width="120" height="30" rx="15" fill="rgba(255,255,255,0.2)"/>
  <text x="1080" y="612" fill="white" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle">
    {{ badge_text }}
  </text>
  {% endif %}

  <!-- Joke text -->
  {% with joke_lines=joke_text|wordwrap:45 %}
  <text fill="white" font-family="Inter, Arial, sans-serif" font-size="32" font-weight="500">
    {% for line in joke_lines.splitlines %}
    <tspan x="60" y="{{ 180|add:forloop.counter0|multiply:45 }}">{{ line }}</tspan>
    {% endfor %}
  </text>
  {% endwith %}
</svg>
```

Create dad_joke.svg (warm/playful - orange accents):
```xml
{% load mathfilters %}
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 630">
  <rect width="1200" height="630" fill="#2d1b00"/>
  <rect y="580" width="1200" height="50" fill="#f39c12"/>
  <text x="60" y="615" fill="#2d1b00" font-family="Inter, Arial, sans-serif" font-size="24" font-weight="600">
    JokesFor.com
  </text>
  <rect x="1020" y="590" width="120" height="30" rx="15" fill="rgba(0,0,0,0.2)"/>
  <text x="1080" y="612" fill="#2d1b00" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle">
    Dad Joke
  </text>
  {% with joke_lines=joke_text|wordwrap:45 %}
  <text fill="#fff5e6" font-family="Inter, Arial, sans-serif" font-size="32" font-weight="500">
    {% for line in joke_lines.splitlines %}
    <tspan x="60" y="{{ 180|add:forloop.counter0|multiply:45 }}">{{ line }}</tspan>
    {% endfor %}
  </text>
  {% endwith %}
</svg>
```

Create dark_humor.svg (dark/edgy - purple/black):
```xml
{% load mathfilters %}
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 630">
  <rect width="1200" height="630" fill="#0d0d0d"/>
  <rect y="580" width="1200" height="50" fill="#6c3483"/>
  <text x="60" y="615" fill="white" font-family="Inter, Arial, sans-serif" font-size="24" font-weight="600">
    JokesFor.com
  </text>
  <rect x="1000" y="590" width="140" height="30" rx="15" fill="rgba(255,255,255,0.1)"/>
  <text x="1070" y="612" fill="white" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle">
    Dark Humor
  </text>
  {% with joke_lines=joke_text|wordwrap:45 %}
  <text fill="#e0e0e0" font-family="Inter, Arial, sans-serif" font-size="32" font-weight="500">
    {% for line in joke_lines.splitlines %}
    <tspan x="60" y="{{ 180|add:forloop.counter0|multiply:45 }}">{{ line }}</tspan>
    {% endfor %}
  </text>
  {% endwith %}
</svg>
```

Create pun.svg (playful - teal/green):
```xml
{% load mathfilters %}
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 630">
  <rect width="1200" height="630" fill="#004d4d"/>
  <rect y="580" width="1200" height="50" fill="#00b894"/>
  <text x="60" y="615" fill="#004d4d" font-family="Inter, Arial, sans-serif" font-size="24" font-weight="600">
    JokesFor.com
  </text>
  <rect x="1050" y="590" width="90" height="30" rx="15" fill="rgba(0,0,0,0.2)"/>
  <text x="1095" y="612" fill="#004d4d" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle">
    Pun
  </text>
  {% with joke_lines=joke_text|wordwrap:45 %}
  <text fill="#e6fff9" font-family="Inter, Arial, sans-serif" font-size="32" font-weight="500">
    {% for line in joke_lines.splitlines %}
    <tspan x="60" y="{{ 180|add:forloop.counter0|multiply:45 }}">{{ line }}</tspan>
    {% endfor %}
  </text>
  {% endwith %}
</svg>
```

Create jokes/templatetags/mathfilters.py for multiply filter:
```python
from django import template
register = template.Library()

@register.filter
def multiply(value, arg):
    """Multiply value by arg."""
    try:
        return int(value) * int(arg)
    except (ValueError, TypeError):
        return ''
```

Also create jokes/templatetags/__init__.py (empty file).
  </action>
  <verify>pip show cairosvg shows installed; ls jokes/templates/jokes/share_cards/ shows 4 SVG files; python -c "from django import template; from jokes.templatetags.mathfilters import multiply; print(multiply(5, 10))" returns 50</verify>
  <done>CairoSVG installed, 4 SVG templates created (base, dad_joke, dark_humor, pun), mathfilters templatetag created</done>
</task>

<task type="auto">
  <name>Task 2: Add share_image field to Joke and implement generation</name>
  <files>jokes/models.py, jokes/share_cards.py, jokes/migrations/XXXX_joke_share_image.py</files>
  <action>
Create jokes/share_cards.py with generation logic:
```python
"""Share card generation using SVG templates and CairoSVG."""
import io
import cairosvg
from django.template.loader import render_to_string


# Tone slug to template mapping
TONE_TEMPLATES = {
    'dad-jokes': 'jokes/share_cards/dad_joke.svg',
    'dark': 'jokes/share_cards/dark_humor.svg',
    'puns': 'jokes/share_cards/pun.svg',
}
DEFAULT_TEMPLATE = 'jokes/share_cards/base_card.svg'


def get_template_for_joke(joke):
    """Get the appropriate SVG template based on joke's primary tone."""
    tone = joke.tones.first()
    if tone:
        return TONE_TEMPLATES.get(tone.slug, DEFAULT_TEMPLATE)
    return DEFAULT_TEMPLATE


def get_badge_text(joke):
    """Get badge text based on joke's primary tone."""
    tone = joke.tones.first()
    return tone.name if tone else 'Joke'


def generate_share_card_png(joke):
    """
    Generate share card PNG for a joke.

    Returns BytesIO buffer containing PNG data.
    """
    template_name = get_template_for_joke(joke)
    badge_text = get_badge_text(joke)

    # Render SVG with joke data
    svg_content = render_to_string(template_name, {
        'joke_text': joke.text,
        'badge_text': badge_text,
    })

    # Convert to PNG
    png_buffer = io.BytesIO()
    cairosvg.svg2png(
        bytestring=svg_content.encode('utf-8'),
        write_to=png_buffer,
        output_width=1200,
        output_height=630
    )
    png_buffer.seek(0)
    return png_buffer
```

In jokes/models.py, add to Joke model:
1. Add share_image field after search_vector:
```python
from django.core.files.base import ContentFile
# ... existing imports ...

class Joke(models.Model):
    # ... existing fields ...

    # Share card
    share_image = models.ImageField(
        upload_to='share-cards/',
        blank=True,
        help_text='Auto-generated share card image for social media'
    )

    # Track original text for change detection
    _original_text = None

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._original_text = self.text if self.pk else None

    def save(self, *args, **kwargs):
        # Check if we need to regenerate share image
        regenerate = False
        if self.pk:
            # Existing joke - check if text changed
            if self._original_text != self.text:
                regenerate = True
        else:
            # New joke - always generate
            regenerate = True

        # Generate share image if needed (after first save to ensure pk exists)
        if not regenerate and not self.share_image:
            regenerate = True

        # Save first to ensure pk exists
        super().save(*args, **kwargs)

        # Generate share image after save
        if regenerate:
            self._generate_share_image()
            # Save again with the image (avoid recursion by using update)
            Joke.objects.filter(pk=self.pk).update(share_image=self.share_image.name)

        self._original_text = self.text

    def _generate_share_image(self):
        """Generate themed share card PNG."""
        from .share_cards import generate_share_card_png

        png_buffer = generate_share_card_png(self)
        filename = f'joke-{self.pk}.png'
        self.share_image.save(filename, ContentFile(png_buffer.read()), save=False)
```

Generate and apply migration:
```bash
python manage.py makemigrations jokes --name joke_share_image
python manage.py migrate
```

Note: The share_image generation only runs on save. Existing jokes won't have images until edited. A management command to regenerate all could be added later if needed.
  </action>
  <verify>python manage.py showmigrations jokes shows new migration; python manage.py shell -c "from jokes.models import Joke; j = Joke.objects.first(); print(j.share_image)" shows field exists; Create or update a joke in admin and verify share-cards/ directory has PNG file</verify>
  <done>share_image field on Joke model, generation on save with change detection, themed templates selected by tone, migration applied</done>
</task>

<task type="auto">
  <name>Task 3: Add share_image_url to joke serializers</name>
  <files>jokes/serializers.py</files>
  <action>
Update JokeSerializer and JokeListSerializer to include share_image_url:

In JokeSerializer, add share_image_url field:
```python
class JokeSerializer(serializers.ModelSerializer):
    # ... existing fields ...
    share_image_url = serializers.SerializerMethodField()

    class Meta:
        model = Joke
        fields = [
            'id', 'text', 'setup', 'punchline',
            'format', 'age_rating', 'language',
            'tones', 'context_tags', 'culture_tags',
            'share_image_url',  # Add this
            'created_at', 'updated_at',
        ]

    def get_share_image_url(self, obj):
        """Return absolute URL for share image if it exists."""
        if obj.share_image:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.share_image.url)
            return obj.share_image.url
        return None
```

Similarly update JokeListSerializer if it should include share_image_url (likely yes for sharing from list views):
```python
class JokeListSerializer(serializers.ModelSerializer):
    # ... existing fields ...
    share_image_url = serializers.SerializerMethodField()

    class Meta:
        model = Joke
        fields = ['id', 'text', 'format', 'age_rating', 'tones', 'share_image_url']

    def get_share_image_url(self, obj):
        if obj.share_image:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.share_image.url)
            return obj.share_image.url
        return None
```

Ensure views pass request context to serializers (DRF does this by default for viewsets, but verify).
  </action>
  <verify>curl http://localhost:8000/api/v1/jokes/1/ shows share_image_url in response (may be null if joke hasn't been saved since migration); Swagger shows share_image_url field in response schema</verify>
  <done>share_image_url exposed in API responses with absolute URLs, works for both detail and list serializers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CairoSVG installed and in requirements.txt
- [ ] 4 SVG templates exist in jokes/templates/jokes/share_cards/
- [ ] mathfilters templatetag exists and works
- [ ] share_image field exists on Joke model
- [ ] Migration applied successfully
- [ ] Saving a joke generates PNG in share-cards/ directory
- [ ] Template selection works based on tone (dad-jokes -> dad_joke.svg)
- [ ] Text change detection prevents unnecessary regeneration
- [ ] share_image_url appears in API responses
- [ ] URLs are absolute (include domain)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Share cards generate successfully for different joke tones
- API includes share_image_url in responses
- No errors in runserver output
</success_criteria>

<output>
After completion, create `.planning/phases/10-sharing/10-02-SUMMARY.md`
</output>
