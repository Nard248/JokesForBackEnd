---
phase: 10-sharing
plan: 03
type: execute
---

<objective>
Create shareable joke URLs with OG meta tags and share event tracking.

Purpose: Enable beautiful social media previews when jokes are shared, and track sharing for analytics.
Output: Public joke share page with OG meta tags, ShareEvent model for tracking, copy-to-clipboard support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-sharing/10-CONTEXT.md
@.planning/phases/10-sharing/10-RESEARCH.md

# Prior plan context
@.planning/phases/10-sharing/10-02-PLAN.md - Share card generation (provides share_image_url)

# Current source files
@jokes/models.py - Add ShareEvent model
@jokes/views.py - Current API views
@JokesForProject/urls.py - URL configuration

**Research findings (from 10-RESEARCH.md):**
- OG meta tags must use absolute URLs for og:image
- Required meta tags: og:title, og:description, og:image, og:image:width, og:image:height, og:type, og:url
- Twitter card: twitter:card (summary_large_image), twitter:image
- Platforms cache aggressively - test with Facebook Debugger and Twitter Card Validator
- Track share button clicks as proxy for actual shares (can't track actual shares reliably)

**Platform requirements:**
- Universal size: 1200 x 630 pixels (already implemented in 10-02)
- Facebook min: 600 x 315
- Max file size: 5-8 MB (our PNGs will be much smaller)

**Patterns:**
- ShareEvent model to track share intent
- No authentication required for public share pages
- API endpoint to record share events (authenticated users only for attribution)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShareEvent model for tracking</name>
  <files>jokes/models.py, jokes/migrations/XXXX_shareevent.py, jokes/admin.py</files>
  <action>
Add ShareEvent model to jokes/models.py:
```python
class ShareEvent(models.Model):
    """Track joke share events for analytics."""
    PLATFORM_CHOICES = [
        ('copy', 'Copy to Clipboard'),
        ('twitter', 'Twitter/X'),
        ('facebook', 'Facebook'),
        ('whatsapp', 'WhatsApp'),
        ('other', 'Other'),
    ]

    joke = models.ForeignKey(
        'Joke',
        on_delete=models.CASCADE,
        related_name='share_events'
    )
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='share_events',
        help_text='Null for anonymous shares'
    )
    platform = models.CharField(
        max_length=20,
        choices=PLATFORM_CHOICES,
        default='other'
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['joke', 'created_at']),
            models.Index(fields=['platform', 'created_at']),
        ]

    def __str__(self):
        user_str = self.user.email if self.user else 'anonymous'
        return f"{user_str} shared joke {self.joke_id} via {self.platform}"
```

In jokes/admin.py, register ShareEventAdmin:
```python
@admin.register(ShareEvent)
class ShareEventAdmin(admin.ModelAdmin):
    list_display = ['id', 'joke_preview', 'user', 'platform', 'created_at']
    list_filter = ['platform', 'created_at']
    search_fields = ['user__email', 'joke__text']
    raw_id_fields = ['joke', 'user']
    date_hierarchy = 'created_at'
    readonly_fields = ['created_at']

    def joke_preview(self, obj):
        return obj.joke.text[:50] + '...' if len(obj.joke.text) > 50 else obj.joke.text
    joke_preview.short_description = 'Joke'
```

Generate and apply migration:
```bash
python manage.py makemigrations jokes --name shareevent
python manage.py migrate
```
  </action>
  <verify>python manage.py showmigrations jokes shows new migration applied; python manage.py shell -c "from jokes.models import ShareEvent; print(ShareEvent._meta.fields)" shows fields; Admin at /admin/jokes/shareevent/ shows model</verify>
  <done>ShareEvent model with joke/user/platform fields, admin registered, migration applied</done>
</task>

<task type="auto">
  <name>Task 2: Create public share page with OG meta tags</name>
  <files>jokes/templates/jokes/share.html, jokes/views.py, jokes/urls.py, JokesForProject/urls.py</files>
  <action>
Create jokes/templates/jokes/share.html:
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ joke.text|truncatechars:60 }} - JokesFor</title>

    <!-- Open Graph -->
    <meta property="og:title" content="{{ joke.text|truncatechars:60 }}" />
    <meta property="og:description" content="Find more jokes at JokesFor.com - the world's best joke search engine" />
    <meta property="og:image" content="{{ share_image_url }}" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="{{ canonical_url }}" />
    <meta property="og:site_name" content="JokesFor" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ joke.text|truncatechars:60 }}" />
    <meta name="twitter:description" content="Find more jokes at JokesFor.com" />
    <meta name="twitter:image" content="{{ share_image_url }}" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .card {
            max-width: 600px;
            background: #16213e;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
        }
        .joke-text {
            font-size: 24px;
            line-height: 1.5;
            margin-bottom: 30px;
        }
        .badge {
            display: inline-block;
            background: #e94560;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .cta {
            margin-top: 30px;
        }
        .cta a {
            display: inline-block;
            background: #e94560;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
        }
        .cta a:hover {
            background: #c73e54;
        }
        .branding {
            margin-top: 40px;
            opacity: 0.7;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="card">
        {% if badge_text %}
        <span class="badge">{{ badge_text }}</span>
        {% endif %}
        <p class="joke-text">{{ joke.text }}</p>
        <div class="cta">
            <a href="/">Find more jokes at JokesFor.com</a>
        </div>
    </div>
    <p class="branding">JokesFor - The world's best joke search engine</p>
</body>
</html>
```

Add view function to jokes/views.py:
```python
from django.shortcuts import render, get_object_or_404
from django.views.decorators.http import require_GET

@require_GET
def joke_share_page(request, pk):
    """
    Public share page for a joke with OG meta tags.

    This page is designed for social media crawlers. It returns
    an HTML page with proper Open Graph and Twitter Card meta tags
    so the joke preview looks great when shared.
    """
    joke = get_object_or_404(
        Joke.objects.select_related('format', 'age_rating').prefetch_related('tones'),
        pk=pk
    )

    # Build absolute URLs
    share_image_url = ''
    if joke.share_image:
        share_image_url = request.build_absolute_uri(joke.share_image.url)

    canonical_url = request.build_absolute_uri()

    # Get badge text from primary tone
    tone = joke.tones.first()
    badge_text = tone.name if tone else None

    return render(request, 'jokes/share.html', {
        'joke': joke,
        'share_image_url': share_image_url,
        'canonical_url': canonical_url,
        'badge_text': badge_text,
    })
```

Update jokes/urls.py to add the share route:
```python
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
# ... existing router registrations ...

urlpatterns = [
    path('', include(router.urls)),
    # Public share page (not under /api/)
    path('jokes/<int:pk>/share/', views.joke_share_page, name='joke-share'),
]
```

Update JokesForProject/urls.py to include the share page at root level:
```python
# Add to urlpatterns, BEFORE the api/ routes
path('jokes/<int:pk>/share/', views.joke_share_page, name='joke-share'),
```

This makes the share URL: https://jokesfor.com/jokes/123/share/
  </action>
  <verify>curl http://localhost:8000/jokes/1/share/ returns HTML with og:image meta tag; View page source and verify all OG tags present; Test URL in Facebook Sharing Debugger (if deployed) or Twitter Card Validator</verify>
  <done>Public share page at /jokes/{id}/share/ with full OG meta tags, Twitter Card support, styled landing page</done>
</task>

<task type="auto">
  <name>Task 3: Add share tracking API endpoint</name>
  <files>jokes/serializers.py, jokes/views.py</files>
  <action>
In jokes/serializers.py, add ShareEventSerializer:
```python
class ShareEventSerializer(serializers.ModelSerializer):
    class Meta:
        model = ShareEvent
        fields = ['id', 'joke', 'platform', 'created_at']
        read_only_fields = ['id', 'created_at']
```

In jokes/views.py, add share() action to JokeViewSet:
```python
@extend_schema(
    description='Record a share event for analytics. Platform: copy, twitter, facebook, whatsapp, other.',
    request={'application/json': {'type': 'object', 'properties': {
        'platform': {'type': 'string', 'enum': ['copy', 'twitter', 'facebook', 'whatsapp', 'other']}
    }}},
    responses={201: {'type': 'object', 'properties': {
        'status': {'type': 'string'},
        'share_url': {'type': 'string'}
    }}},
)
@action(detail=True, methods=['post'])
def share(self, request, pk=None):
    """
    Record share event: POST /api/v1/jokes/{id}/share/ with {"platform": "twitter"}

    Returns the shareable URL for the joke.
    Authentication optional - tracks user if authenticated.
    """
    joke = self.get_object()
    platform = request.data.get('platform', 'other')

    # Validate platform
    valid_platforms = [choice[0] for choice in ShareEvent.PLATFORM_CHOICES]
    if platform not in valid_platforms:
        platform = 'other'

    # Create share event
    ShareEvent.objects.create(
        joke=joke,
        user=request.user if request.user.is_authenticated else None,
        platform=platform
    )

    # Build share URL
    share_url = request.build_absolute_uri(f'/jokes/{joke.pk}/share/')

    return Response({
        'status': 'recorded',
        'share_url': share_url,
        'joke_id': joke.pk,
    }, status=status.HTTP_201_CREATED)
```

Update the permission_classes for share action to allow unauthenticated users:
```python
from rest_framework.permissions import IsAuthenticated, AllowAny

# In JokeViewSet
def get_permissions(self):
    """Allow unauthenticated access to share endpoint."""
    if self.action == 'share':
        return [AllowAny()]
    return super().get_permissions()
```

Don't forget to import ShareEvent at the top of views.py.
  </action>
  <verify>curl -X POST http://localhost:8000/api/v1/jokes/1/share/ -H "Content-Type: application/json" -d '{"platform": "twitter"}' returns 201 with share_url; Check ShareEvent in admin shows new record; Swagger shows share endpoint</verify>
  <done>POST /api/v1/jokes/{id}/share/ records share events, returns share URL, works for both authenticated and anonymous users</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ShareEvent model exists with proper fields
- [ ] Migration applied successfully
- [ ] Admin shows ShareEvent model with filters
- [ ] /jokes/{id}/share/ returns HTML page
- [ ] OG meta tags present in share page HTML
- [ ] og:image uses absolute URL
- [ ] Twitter Card meta tags present
- [ ] POST /api/v1/jokes/{id}/share/ records events
- [ ] Share tracking works for anonymous users
- [ ] Share URL returned in response
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Share pages render correctly
- Share events tracked in database
- OG meta tags valid for social media previews
- Phase 10: Sharing complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-sharing/10-03-SUMMARY.md`

This completes Phase 10: Sharing. The full feature set:
- JokeRating model with thumbs up/down voting (10-01)
- Rating API with aggregate scores (10-01)
- Themed share card generation (10-02)
- share_image_url in API responses (10-02)
- Public share pages with OG meta tags (10-03)
- Share event tracking for analytics (10-03)
</output>
